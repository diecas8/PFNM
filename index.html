<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Geoportal</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <style>
        body {
            margin: 0;
            height: 100vh;
            display: flex;
            overflow: hidden;
        }
        #map {
            width: 100%;
            height: 100%;
        }
        .summary-container {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.9);
            box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.2);
            padding: 10px;
            border-radius: 8px;
            font-size: 14px;
            line-height: 1.5;
            max-width: 300px;
            z-index: 1000;
        }
        .summary-container strong {
            display: block;
            margin-bottom: 5px;
        }
        .summary-container button {
            margin-top: 10px;
            padding: 5px 10px;
            background-color: #0288d1;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        .summary-container button:hover {
            background-color: #0277bd;
        }
        .chart-container {
            margin-top: 10px;
            height: 150px;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    <div class="summary-container" id="summary-container">
        <strong>Detalle de Cultivos</strong>
        <div id="summary-detail"></div>
        <button onclick="descargarResumen()">Descargar Resumen</button>
    </div>

    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // Inicializar el mapa
        var map = L.map('map').setView([5.40139, -71.05203], 10);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 18,
            attribution: '© OpenStreetMap contributors'
        }).addTo(map);

        var geojsonData, chart;
        const summaryDetailDiv = document.getElementById('summary-detail');

        // Colores predefinidos para cultivos
        const colorMap = {
            'bosque de galería': '#1b5e20',
            'pasto limpio': '#43a047',
            'pasto enmalezado': '#f4511e',
            'palma aceite': '#fbc02d',
            'infraestructura': '#9e9e9e',
            'otros': '#8e44ad'
        };

        // Cargar GeoJSON y asignar colores al mapa
        function cargarGeoJSON(url) {
            fetch(url)
                .then(res => res.json())
                .then(data => {
                    geojsonData = data;
                    L.geoJSON(data, {
                        style: feature => {
                            const cultivo = feature.properties.cultivo || 'otros';
                            return {
                                color: colorMap[cultivo] || '#000000',
                                fillOpacity: 0.7,
                                weight: 1
                            };
                        },
                        onEachFeature: (feature, layer) => {
                            const area = parseFloat(feature.properties.has || 0).toFixed(2);
                            layer.bindPopup(`Cultivo: ${feature.properties.cultivo}<br>Área: ${area} ha`);
                        }
                    }).addTo(map);
                })
                .catch(err => console.error('Error al cargar GeoJSON:', err));
        }

        // Actualizar resumen flotante
        function actualizarResumen(cultivos, areaTotal) {
            let detalleHTML = '';
            Object.entries(cultivos).forEach(([cultivo, area]) => {
                detalleHTML += `<p>${cultivo}: ${area.toFixed(2)} ha</p>`;
            });
            detalleHTML += `<p><strong>Total:</strong> ${areaTotal.toFixed(2)} ha</p>`;
            summaryDetailDiv.innerHTML = detalleHTML;
        }

        // Descargar resumen como archivo de texto
        function descargarResumen() {
            const detalle = summaryDetailDiv.innerText;
            const blob = new Blob([detalle], { type: 'text/plain' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'resumen_cultivos.txt';
            link.click();
        }

        // Cargar cultivos
        cargarGeoJSON('./Cultivos.geojson');
    </script>
</body>
</html>
