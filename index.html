<script>
    // Declarar la función globalmente para que sea accesible
    function centrarEnFinca() {
        const selectedFinca = fincaSelector.value;
        if (!selectedFinca || !geojsonData) return;

        let areaTotal = 0;
        let propietario = "N/A";
        const cultivos = {};

        const bounds = L.latLngBounds();

        geojsonData.features.forEach(feature => {
            if (feature.properties.cod_finca === selectedFinca) {
                const cultivo = feature.properties.cultivo 
                    ? feature.properties.cultivo.trim().toLowerCase() 
                    : "Sin información";
                const area = parseFloat(feature.properties.has) || 0;

                // Sumar el área total
                areaTotal += area;

                // Obtener el propietario
                propietario = feature.properties.propietari || propietario;

                // Sumar áreas por cultivo
                if (!cultivos[cultivo]) {
                    cultivos[cultivo] = 0;
                }
                cultivos[cultivo] += area;

                // Extender los bounds para centrar el mapa
                if (feature.geometry) {
                    bounds.extend(L.geoJSON(feature).getBounds());
                }
            }
        });

        // Mostrar resumen
        const nombreFinca = fincaSelector.options[fincaSelector.selectedIndex].text.split(" - ")[1];
        summaryDiv.innerHTML = `
            <strong>Nombre de la Finca:</strong> ${nombreFinca}<br>
            <strong>Propietario:</strong> ${propietario}<br>
            <strong>Área Total:</strong> ${areaTotal.toLocaleString('es-ES', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} ha
        `;

        generarGrafico(cultivos);

        map.fitBounds(bounds);
    }

    function generarGrafico(cultivos) {
        if (chart) {
            chart.destroy(); // Eliminar gráfico previo si existe
        }

        const labels = Object.keys(cultivos).sort();
        const data = labels.map(cultivo => cultivos[cultivo]);
        const backgroundColors = labels.map(cultivo => colorMap[cultivo] || '#D3D3D3');

        chart = new Chart(chartCanvas, {
            type: 'pie',
            data: {
                labels: labels,
                datasets: [{
                    data: data,
                    backgroundColor: backgroundColors
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: { position: 'top' }
                }
            }
        });
    }
</script>
