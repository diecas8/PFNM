<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Geoportal</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <style>
        body {
            margin: 0;
            display: flex;
            height: 100vh;
            overflow: hidden;
        }
        #map { width: 100%; height: 100%; }
        .floating-summary {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(255, 255, 255, 0.9);
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            font-size: 14px;
            max-width: 300px;
            z-index: 1000;
        }
        .legend {
            position: absolute;
            bottom: 10px;
            right: 10px;
            background: rgba(255, 255, 255, 0.9);
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            font-size: 12px;
            z-index: 1000;
        }
        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
        }
        .legend-color {
            width: 15px;
            height: 15px;
            margin-right: 5px;
            border: 1px solid #000;
        }
        select {
            margin-top: 10px;
            padding: 5px;
            width: 100%;
        }
    </style>
</head>
<body>
    <div class="floating-summary" id="summary">
        <strong>Resumen:</strong><br>
        Seleccione una finca para ver detalles.
    </div>
    <div class="legend" id="legend">
        <strong>Colores de Cultivos:</strong>
        <!-- Se actualizará dinámicamente -->
    </div>
    <div id="map"></div>

    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // Inicializar el mapa
        const map = L.map('map').setView([5.40139, -71.05203], 10);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 18,
            attribution: '© OpenStreetMap contributors'
        }).addTo(map);

        const fincaSelector = document.createElement('select');
        fincaSelector.id = 'fincaSelector';
        fincaSelector.onchange = centrarEnFinca;
        fincaSelector.innerHTML = '<option value="">Seleccione una finca</option>';
        document.body.appendChild(fincaSelector);

        const summaryDiv = document.getElementById('summary');
        const legendDiv = document.getElementById('legend');

        // Colores predefinidos para cultivos
        const colorMap = {
            'bosque de galería': '#1b5e20', // Verde oscuro
            'pasto limpio': '#43a047',
            'pasto enmalezado': '#f4511e',
            'palma aceite': '#fbc02d',
            'infraestructura': '#757575',
            'otros': '#8e44ad'
        };

        const defaultColors = [
            '#fdd835', '#0288d1', '#03a9f4', '#6d4c41', '#ff5722', 
            '#795548', '#8bc34a', '#d81b60', '#00acc1', '#cddc39'
        ];
        let geojsonData, chart;

        // Función para cargar una capa GeoJSON
        function cargarGeoJSON(url, styleCallback, layerName) {
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    const layer = L.geoJSON(data, { style: styleCallback }).addTo(map);
                    map.addLayer(layer);
                    map.on('overlayadd', actualizarLeyenda);
                    actualizarLeyenda();
                })
                .catch(err => console.error(`Error cargando ${layerName}:`, err));
        }

        // Procesar GeoJSON de cultivos
        function procesarGeoJSON(data) {
            const fincas = new Set();
            L.geoJSON(data, {
                style: feature => {
                    const cultivo = feature.properties.cultivo || 'otros';
                    if (!colorMap[cultivo]) {
                        colorMap[cultivo] = defaultColors.pop() || '#000000';
                    }
                    return { color: colorMap[cultivo], fillOpacity: 0.7, weight: 1 };
                },
                onEachFeature: (feature, layer) => {
                    const codFinca = feature.properties.cod_finca || "N/A";
                    const nomFinca = feature.properties.nom_finca_ || "Sin nombre";
                    const propietario = feature.properties.propietari || "Sin propietario";
                    const fincaLabel = `${codFinca} - ${nomFinca}`;

                    fincas.add(fincaLabel);

                    const cultivo = feature.properties.cultivo || 'Sin información';
                    const area = parseFloat(feature.properties.has || 0).toFixed(2);
                    layer.bindPopup(`
                        <strong>Cultivo:</strong> ${cultivo}<br>
                        <strong>Área:</strong> ${area} ha<br>
                        <strong>Propietario:</strong> ${propietario}
                    `);
                }
            }).addTo(map);

            // Actualizar selector de fincas
            fincaSelector.innerHTML = '<option value="">Seleccione una finca</option>';
            Array.from(fincas).sort().forEach(finca => {
                const option = document.createElement('option');
                option.value = finca.split(' - ')[0];
                option.textContent = finca;
                fincaSelector.appendChild(option);
            });

            actualizarLeyenda();
        }

        // Función para centrar en una finca seleccionada
        function centrarEnFinca() {
            const selectedFinca = fincaSelector.value;
            if (!selectedFinca || !geojsonData) return;

            let areaTotal = 0;
            const cultivos = {};
            const bounds = L.latLngBounds();

            geojsonData.features.forEach(feature => {
                if (feature.properties.cod_finca === selectedFinca) {
                    const cultivo = feature.properties.cultivo || 'otros';
                    const area = parseFloat(feature.properties.has || 0);

                    if (!cultivos[cultivo]) cultivos[cultivo] = 0;
                    cultivos[cultivo] += area;
                    areaTotal += area;

                    bounds.extend(L.geoJSON(feature).getBounds());
                }
            });

            map.fitBounds(bounds);
            actualizarResumen(selectedFinca, cultivos, areaTotal);
        }

        // Actualizar el cuadro resumen flotante
        function actualizarResumen(codigo, cultivos, areaTotal) {
            const nombreFinca = fincaSelector.options[fincaSelector.selectedIndex].text.split(' - ')[1];
            summaryDiv.innerHTML = `
                <strong>Código:</strong> ${codigo}<br>
                <strong>Nombre de la Finca:</strong> ${nombreFinca}<br>
                <strong>Área Total:</strong> ${areaTotal.toFixed(2)} ha
            `;
        }

        // Actualizar leyenda dinámica
        function actualizarLeyenda() {
            legendDiv.innerHTML = '<strong>Colores de Cultivos:</strong>';
            Object.keys(colorMap).forEach(cultivo => {
                const item = document.createElement('div');
                item.className = 'legend-item';
                item.innerHTML = `<div class="legend-color" style="background:${colorMap[cultivo]}"></div>${cultivo}`;
                legendDiv.appendChild(item);
            });
        }

        // Cargar capas
        cargarGeoJSON('./Rutas.geojson', { color: '#FF6347', weight: 2 }, 'Rutas');
        cargarGeoJSON('./fincas.geojson', { color: '#000000', weight: 1 }, 'Fincas');
        fetch('./Cultivos.geojson')
            .then(response => response.json())
            .then(procesarGeoJSON);
    </script>
</body>
</html>
